<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Applications — Admin</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header class="header-inner"><img src="images/logo.svg" class="logo"><div class="title"><h1>Admin — Applications</h1></div></header>
  <nav>
    <a href="index.html">Home</a>
    <a href="admin.html" class="active">Admin</a>
  </nav>

  <main>
    <section class="section">
      <h2>Login (Admin)</h2>
      <form id="loginForm">
        <input name="email" type="email" placeholder="admin@example.com" required>
        <input name="password" type="password" placeholder="password" required>
        <button type="submit" class="button">Login</button>
      </form>
      <div id="loginMsg"></div>

      <hr>

      <div id="app-area" style="display:none">
        <h3>Applications</h3>
        <div>
          Filter:
          <select id="filterStatus">
            <option value="">All</option>
            <option>new</option>
            <option>under_review</option>
            <option>interview</option>
            <option>offered</option>
            <option>rejected</option>
          </select>
          <button id="refreshBtn" class="button">Refresh</button>
        </div>

        <table id="appsTable" style="width:100%; margin-top:12px; border-collapse: collapse;">
          <thead><tr><th>Applied</th><th>Name</th><th>Email</th><th>Position</th><th>Status</th><th>Actions</th></tr></thead>
          <tbody></tbody>
        </table>

        <div id="detail" style="margin-top:20px"></div>
      </div>
    </section>
  </main>

<script>
let token = localStorage.getItem('admin_token') || null;

async function api(path, opts = {}) {
  opts.headers = opts.headers || {};
  if (token) opts.headers['Authorization'] = 'Bearer ' + token;
  const res = await fetch(path, opts);
  if (res.status === 401) {
    // logged out
    token = null;
    localStorage.removeItem('admin_token');
    document.getElementById('app-area').style.display = 'none';
    return { error: 'unauthorized' };
  }
  return res.json();
}

/* login */
document.getElementById('loginForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const data = new FormData(e.target);
  const body = { email: data.get('email'), password: data.get('password') };
  const res = await fetch('/api/auth/login', {
    method: 'POST',
    headers: { 'Content-Type':'application/json' },
    body: JSON.stringify(body)
  });
  const j = await res.json();
  if (!res.ok) {
    document.getElementById('loginMsg').textContent = j.message || 'Login failed';
    return;
  }
  token = j.token;
  localStorage.setItem('admin_token', token);
  document.getElementById('loginMsg').textContent = 'Logged in';
  document.getElementById('app-area').style.display = 'block';
  loadApps();
});

/* load apps */
async function loadApps() {
  const status = document.getElementById('filterStatus').value || '';
  const q = status ? '?status=' + encodeURIComponent(status) : '';
  const data = await api('/api/applications' + q);
  if (data.error) return;
  const tbody = document.querySelector('#appsTable tbody');
  tbody.innerHTML = '';
  data.items.forEach(app => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${new Date(app.appliedAt).toLocaleString()}</td>
                    <td>${app.name}</td>
                    <td>${app.email}</td>
                    <td>${app.position}</td>
                    <td>${app.status}</td>
                    <td>
                      <button class="button" data-id="${app._id}" onclick="viewApp('${app._id}')">View</button>
                    </td>`;
    tbody.appendChild(tr);
  });
}

/* view detail */
async function viewApp(id) {
  const data = await api('/api/applications/' + id);
  if (data.error) return alert('Unable to load');
  const d = document.getElementById('detail');
  d.innerHTML = `
    <h3>${data.name} — ${data.position}</h3>
    <p><strong>Email:</strong> ${data.email}</p>
    <p><strong>Phone:</strong> ${data.phone || '—'}</p>
    <p><strong>Cover:</strong> ${data.coverLetter || '—'}</p>
    <p><strong>Status:</strong> ${data.status}</p>
    <div>
      <strong>Files</strong>
      <ul>
        ${data.files.map(f => `<li><a href="#" onclick="downloadFile('${id}','${encodeURIComponent(f.key)}')">${f.originalName}</a></li>`).join('')}
      </ul>
    </div>
    <div style="margin-top:12px">
      <select id="newStatus">
        <option value="under_review">Under review</option>
        <option value="interview">Interview</option>
        <option value="offered">Offered</option>
        <option value="rejected">Rejected</option>
      </select>
      <input id="note" placeholder="Add note" style="width:60%" />
      <button class="button" onclick="updateStatus('${id}')">Save</button>
    </div>
  `;
}

/* update status */
async function updateStatus(id) {
  const status = document.getElementById('newStatus').value;
  const note = document.getElementById('note').value;
  const res = await api('/api/applications/' + id + '/status', {
    method: 'PUT',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({ status, note })
  });
  if (res.ok === false) alert('Error saving');
  else { loadApps(); alert('Saved'); }
}

/* download file (gets signed url) */
async function downloadFile(appId, keyEnc) {
  const key = decodeURIComponent(keyEnc);
  const res = await api(`/api/applications/${appId}/files/${encodeURIComponent(key)}/download`);
  if (res.url) window.open(res.url, '_blank');
  else alert('Unable to create download link');
}

document.getElementById('refreshBtn').addEventListener('click', loadApps);
document.getElementById('filterStatus').addEventListener('change', loadApps);
if (localStorage.getItem('admin_token')) {
  token = localStorage.getItem('admin_token');
  document.getElementById('app-area').style.display = 'block';
  loadApps();
}
</script>
</body>
</html>
